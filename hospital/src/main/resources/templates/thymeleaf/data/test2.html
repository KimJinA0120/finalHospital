<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>주식 시세 데이터</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <h1>주식 시세 데이터 보기</h1>
    <table id="stockDataTable">
        <thead>
            <tr>
                <th>날짜</th>
                <th>마감가</th>
                <th>변동률</th>
                <th>총 거래량</th>
                <th>총 거래대금</th>
            </tr>
        </thead>
        <tbody id="stockDataBody">
            <tr id="initialStockRow">
                <td id="currentDateCell"></td>
                <td id="currentClosePriceCell"></td>
                <td id="currentChangeRateCell"></td>
                <td id="currentTotalVolumeCell">0</td>
                <td id="currentTotalTradingValueCell">0</td>
            </tr>
        </tbody>
    </table>

    <script>
        // WebSocket 연결
        const stockSocket = new WebSocket('ws://localhost:2000');

        // 초기 누적 값 로드
        let accumulatedVolume = parseInt(localStorage.getItem('accumulatedVolume')) || 0;
        let accumulatedTradingValue = parseFloat(localStorage.getItem('accumulatedTradingValue')) || 0;
        let previousPrice = parseFloat(localStorage.getItem('previousPrice')) || 55300; // 초기 마감가
        const currentDate = new Date().toISOString().slice(0, 10); // YYYY-MM-DD 형식

        // 오늘 날짜 초기화
        if (!localStorage.getItem('lastTrackedDate')) {
            localStorage.setItem('lastTrackedDate', currentDate);
        }

        // 페이지 로드 시 기존 값 설정
        document.getElementById('currentDateCell').textContent = currentDate; 
        document.getElementById('currentClosePriceCell').textContent = previousPrice; 
        document.getElementById('currentTotalVolumeCell').textContent = accumulatedVolume; 
        document.getElementById('currentTotalTradingValueCell').textContent = accumulatedTradingValue.toFixed(2); 

        // 기존 데이터 로드
        const historicalData = JSON.parse(localStorage.getItem('historicalStockData')) || [];
        historicalData.forEach(data => {
            const newStockRow = document.createElement('tr');
            newStockRow.innerHTML = `
                <td>${data.date}</td>
                <td>${data.price}</td>
                <td>${data.changeRate}</td>
                <td>${data.volume}</td>
                <td>${data.tradingValue}</td>
            `;
            document.getElementById('stockDataBody').appendChild(newStockRow);
        });

        stockSocket.onmessage = function(event) {
            const stockMessage = JSON.parse(event.data);
            const todayDate = new Date().toISOString().slice(0, 10); // 오늘 날짜
            const currentPrice = parseFloat(stockMessage.price);
            
            // 하루가 바뀌었는지 확인
            if (todayDate !== localStorage.getItem('lastTrackedDate')) {
                // 하루가 바뀌었으면 초기화
                const previousTrackedDate = localStorage.getItem('lastTrackedDate');

                // 새로운 행 추가
                const newStockRow = document.createElement('tr');
                const changeRate = ((currentPrice - previousPrice) / previousPrice * 100).toFixed(2);
                newStockRow.innerHTML = `
                    <td>${previousTrackedDate}</td>
                    <td>${previousPrice}</td>
                    <td>${changeRate}%</td>
                    <td>${accumulatedVolume}</td>
                    <td>${accumulatedTradingValue.toFixed(2)}</td>
                `;
                document.getElementById('stockDataBody').appendChild(newStockRow);

                // 날짜 업데이트
                localStorage.setItem('lastTrackedDate', todayDate);
                localStorage.setItem('previousPrice', currentPrice); // 현재 가격을 전날 가격으로 저장

                // 기존 데이터를 localStorage에 저장
                historicalData.push({
                    date: previousTrackedDate,
                    price: previousPrice,
                    changeRate: changeRate,
                    volume: accumulatedVolume,
                    tradingValue: accumulatedTradingValue.toFixed(2)
                });
                localStorage.setItem('historicalStockData', JSON.stringify(historicalData));

                // 초기화
                accumulatedVolume = 0; 
                accumulatedTradingValue = 0; 
                
                // previousPrice 업데이트
                previousPrice = currentPrice; // 현재 가격을 전날의 마지막 가격으로 업데이트
            }

            // 데이터 업데이트
            document.getElementById('currentDateCell').textContent = todayDate; 
            document.getElementById('currentClosePriceCell').textContent = currentPrice; 

            // changeRate 계산
            const changeRate = ((currentPrice - previousPrice) / previousPrice) * 100; // 변동률 계산
            document.getElementById('currentChangeRateCell').textContent = changeRate.toFixed(2) + '%'; 

            // 거래량 및 거래대금 누적
            const volume = stockMessage.volume;
            accumulatedVolume += volume; // 누적 거래량
            accumulatedTradingValue += (currentPrice * volume); // 누적 거래대금

            // UI 업데이트
            document.getElementById('currentTotalVolumeCell').textContent = accumulatedVolume; // 총 거래량 업데이트
            document.getElementById('currentTotalTradingValueCell').textContent = accumulatedTradingValue; // 총 거래대금 업데이트

            // localStorage에 누적 값 저장
            localStorage.setItem('accumulatedVolume', accumulatedVolume);
            localStorage.setItem('accumulatedTradingValue', accumulatedTradingValue);
        };
    </script>
</body>
</html>
