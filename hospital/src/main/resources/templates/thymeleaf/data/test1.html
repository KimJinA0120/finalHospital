<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>일별 시세 보기</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <h1>일별 시세 보기</h1>
    <table id="stockTable">
        <thead>
            <tr>
                <th>날짜</th>
                <th>종가</th>
                <th>등락률</th>
                <th>거래량</th>
                <th>거래대금</th>
            </tr>
        </thead>
        <tbody id="stockBody">
            <tr id="stockRow">
                <td id="dateCell"></td>
                <td id="priceCell"></td>
                <td id="changeRateCell"></td>
                <td id="volumeCell">0</td>
                <td id="tradingValueCell">0</td>
            </tr>
        </tbody>
    </table>

    <script>
        // WebSocket 연결
        const socket = new WebSocket('ws://localhost:2000');

        // 초기 누적 값 로드
        let totalVolume = parseInt(localStorage.getItem('totalVolume')) || 0;
        let totalTradingValue = parseFloat(localStorage.getItem('totalTradingValue')) || 0;
        let lastPrice = parseFloat(localStorage.getItem('lastPrice')) || 55300; // 초기 종가
        const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD 형식

        // 오늘 날짜 초기화
        if (!localStorage.getItem('lastDate')) {
            localStorage.setItem('lastDate', today);
        }

        // 페이지 로드 시 기존 값 설정
        document.getElementById('dateCell').textContent = today; 
        document.getElementById('priceCell').textContent = lastPrice; 
        document.getElementById('volumeCell').textContent = totalVolume; 
        document.getElementById('tradingValueCell').textContent = totalTradingValue.toFixed(2); 

        // 기존 데이터 로드
        const existingData = JSON.parse(localStorage.getItem('stockData')) || [];
        existingData.forEach(data => {
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>${data.date}</td>
                <td>${data.price}</td>
                <td>${data.changeRate}</td>
                <td>${data.volume}</td>
                <td>${data.tradingValue}</td>
            `;
            document.getElementById('stockBody').appendChild(newRow);
        });

        socket.onmessage = function(event) {
            const message = JSON.parse(event.data);
            const currentDate = new Date().toISOString().slice(0, 10); // 오늘 날짜
            const price = parseFloat(message.price);
            
            // 하루가 바뀌었는지 확인
            if (currentDate !== localStorage.getItem('lastDate')) {
                // 하루가 바뀌었으면 초기화
                const previousDate = localStorage.getItem('lastDate');

                // 새로운 행 추가
                const newRow = document.createElement('tr');
                const changeRate = ((price - lastPrice) / lastPrice * 100).toFixed(2);
                newRow.innerHTML = `
                    <td>${previousDate}</td>
                    <td>${lastPrice}</td>
                    <td>${changeRate}%</td>
                    <td>${totalVolume}</td>
                    <td>${totalTradingValue.toFixed(2)}</td>
                `;
                document.getElementById('stockBody').appendChild(newRow);

                // 날짜 업데이트
                localStorage.setItem('lastDate', currentDate);
                localStorage.setItem('lastPrice', price); // 현재 가격을 전날 가격으로 저장

                // 기존 데이터를 localStorage에 저장
                existingData.push({
                    date: previousDate,
                    price: lastPrice,
                    changeRate: changeRate,
                    volume: totalVolume,
                    tradingValue: totalTradingValue.toFixed(2)
                });
                localStorage.setItem('stockData', JSON.stringify(existingData));

                // 초기화
                totalVolume = 0; 
                totalTradingValue = 0; 
                
                // lastPrice 업데이트
                lastPrice = price; // 현재 가격을 전날의 마지막 가격으로 업데이트
            }

            // 데이터 업데이트
            document.getElementById('dateCell').textContent = currentDate; 
            document.getElementById('priceCell').textContent = price; 

            // changeRate 계산
            const changeRate = ((price - lastPrice) / lastPrice) * 100; // 등락률 계산
            document.getElementById('changeRateCell').textContent = changeRate.toFixed(2) + '%'; 

            // 거래량 및 거래대금 누적
            const volume = message.volume;
            totalVolume += volume; // 누적 거래량
            totalTradingValue += (price * volume); // 누적 거래대금

            // UI 업데이트
            document.getElementById('volumeCell').textContent = totalVolume; // 총 거래량 업데이트
            document.getElementById('tradingValueCell').textContent = totalTradingValue; // 총 거래대금 업데이트

            // localStorage에 누적 값 저장
            localStorage.setItem('totalVolume', totalVolume);
            localStorage.setItem('totalTradingValue', totalTradingValue);
            
       

        };
    </script>
</body>
</html>
